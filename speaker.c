#include <8051.h>
#define FQ 62500

unsigned short nowtone = 0; //發出的音調
unsigned short nowl = 65525; //發出的音長

unsigned char playcount;  //樂譜進度

unsigned char interrupt_count;

unsigned short musiclengh = 340;

const unsigned char sheet[340] = {5, 7, 0, 7, 9, 12, 10, 9, 5, 7, 0, 0, 0, 2, 5, 5, 5, 7, 0, 7, 9, 12, 10, 9, 5, 7, 0, 0, 0, 2, 5, 5, 16, 2, 4, 5, 5, 7, 4, 2, 0, 16, 16, 2, 
2, 4, 5, 2, 0, 12, 16, 12, 7, 16, 2, 2, 4, 5, 2, 5, 7, 16, 16, 4, 2, 0, 16, 16, 2, 2, 4, 5, 2, 0, 7, 7, 7, 9, 7, 16, 5, 7, 9, 5, 7, 7, 7, 9, 7, 0, 16, 2, 4, 5, 2, 16, 7, 9, 7, 0, 2, 5, 2, 9, 9, 7, 0, 2, 5, 2, 7, 7, 5, 4, 2, 0, 2, 5, 2, 5, 7, 4, 2, 0, 0, 0, 7, 5, 0, 2, 5, 2, 9, 9, 7, 0, 2, 5, 2, 12, 4, 5, 4, 2, 0, 2, 5, 2, 5, 7, 4, 2, 0, 0, 7, 5, 16, 16, 2, 5, 2, 5, 7, 16, 16, 4, 2, 0, 16, 16, 2, 2, 4, 5, 2, 0, 16, 12, 12, 7, 9, 7, 5, 16, 0, 2, 4, 5, 2, 16, 4, 2, 0, 16, 2, 2, 4, 5, 2, 0, 16, 16, 7, 7, 9, 7, 5, 5, 7, 9, 7, 7, 7, 9, 7, 0, 0, 16, 0, 2, 4, 5, 2, 16, 7, 9, 7, 0, 2, 5, 2, 9, 9, 7, 0, 2, 5, 2, 7, 7, 5, 4, 2, 0, 2, 5, 2, 5, 7, 4, 2, 0, 0, 7, 5, 0, 2, 5, 2, 9, 9, 7, 0, 2, 5, 2, 12, 4, 5, 4, 2, 0, 2, 5, 2, 5, 7, 4, 2, 0, 0, 7, 5, 0, 2, 5, 2, 9, 9, 7, 0, 2, 5, 2, 12, 4, 5, 4, 2, 0, 2, 5, 2, 5, 7, 4, 2, 0, 0, 7, 5, 0, 2, 5, 
2, 9, 9, 7, 0, 2, 5, 2, 12, 4, 5, 4, 2, 0, 2, 5, 2, 5, 7, 4, 2, 0, 0, 7, 5, 16};
                    
const unsigned char sheetl[340] = {2, 2, 1, 2, 2, 5, 5, 3, 2, 2, 0, 5, 5, 5, 3, 5, 2, 2, 1, 2, 2, 5, 5, 3, 2, 2, 0, 5, 5, 5, 3, 5, 1, 3, 3, 3, 3, 3, 4, 5, 0, 1, 3, 3, 3, 3, 3, 1, 3, 3, 3, 3, 2, 1, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 2, 1, 3, 3, 3, 3, 3, 3, 1, 3, 3, 3, 3, 1, 1, 0, 3, 3, 3, 3, 3, 3, 3, 1, 1, 0, 3, 3, 
3, 3, 3, 3, 3, 2, 5, 5, 5, 5, 4, 4, 2, 5, 5, 5, 5, 4, 4, 4, 5, 4, 5, 5, 5, 5, 1, 3, 4, 5, 3, 3, 3, 1, 0, 5, 5, 5, 5, 4, 4, 2, 5, 5, 5, 5, 1, 3, 4, 5, 3, 5, 5, 5, 5, 1, 3, 4, 5, 1, 3, 1, 0, 1, 3, 3, 3, 3, 3, 1, 3, 3, 3, 3, 2, 1, 3, 3, 3, 3, 3, 3, 1, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 2, 1, 3, 3, 3, 3, 3, 1, 3, 3, 3, 3, 1, 2, 0, 3, 3, 3, 1, 3, 3, 3, 3, 3, 1, 2, 3, 3, 3, 3, 3, 3, 3, 3, 2, 5, 5, 5, 5, 4, 4, 
2, 5, 5, 5, 5, 4, 4, 4, 5, 3, 5, 5, 5, 5, 1, 3, 4, 5, 1, 3, 1, 0, 5, 5, 5, 5, 4, 4, 2, 5, 5, 5, 5, 1, 3, 4, 5, 3, 5, 5, 5, 5, 1, 3, 4, 5, 1, 3, 1, 0, 5, 5, 5, 5, 4, 4, 2, 5, 5, 5, 5, 1, 3, 4, 5, 3, 5, 5, 5, 5, 1, 3, 4, 5, 1, 3, 1, 0, 5, 5, 5, 5, 4, 4, 2, 5, 5, 5, 5, 1, 3, 4, 5, 3, 5, 5, 5, 5, 1, 3, 4, 5, 1, 3, 1, 0, 1};       
const unsigned short tone[] = {64400,64464,64522,64580,64634,64685,64733,64778,64820,64860,64898,64934,64968,65000,65030,65058,0};
const unsigned short tlengh[] = {9600, 4800, 7200, 2400, 3600, 1800, 1200};


void timertone(void) __interrupt (1) __using (1) //設定音階
{
    TH0 = (char)(nowtone>>8);
    TL0 = (char)(nowtone);
    P1 = ~P1;
}

void timerlengh(void) __interrupt (3) __using (2) //控制節拍的頻率
{
    TH1 = (char)((65536-nowl)>>8);
    TL1 = (char)(65536-nowl);
    interrupt_count++;
    if(interrupt_count == 99) //音符之間的中斷點
        nowtone = 0;
    //下一個音階
    if(interrupt_count > 99){
        playcount++;
        playcount %= musiclengh;
        nowtone = tone[sheet[playcount]];
        nowl = tlengh[sheetl[playcount]];
        interrupt_count = 0;
    }
}

void main(){
    //初始化interrupt
    TMOD = 0x11;
    TH0 = (char)(nowtone>>8);
    TL0 = (char)(nowtone);
    TH1 = (char)((65536-FQ)>>8);
    TL1 = (char)(65536-FQ);

    EA = 1;
    ET0 = 1;
    ET1 = 1;
    TR0 = 1;
    TR1 = 1;
    P0 = 0x00;
    while (1);
    
}